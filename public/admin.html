<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Push Admin</title>
<style>
  body{font-family:system-ui,sans-serif;max-width:420px;margin:2rem auto;padding:1rem}
  input,textarea,button{width:100%;font-size:1rem;padding:.6rem;margin:.4rem 0;border:1px solid #ccc;border-radius:6px}
  button{background:#007bff;color:#fff;border:none}
  button:hover{background:#0056b3}
  #form{display:none}
  #err{color:#e74c3c;display:none}
</style>

<h2>üì¢ Send Push Notification</h2>

<div id="login">
  <input id="pw" type="password" autocomplete="current-password" placeholder="Admin password">
  <button onclick="unlock()">Unlock</button>
  <p id="err">Wrong password</p>
</div>

<form id="form" onsubmit="send();return false;">
  <input id="title" placeholder="Title" required>
  <textarea id="body" placeholder="Message" required></textarea>
  <input id="url" placeholder="Click-through URL (optional)">
  <button>Send</button>
</form>

<script>
  const KEY = 'push-admin-pass';

  /* test the password by calling /api/send in "test" mode */
  async function testPass(pass){
    const res = await fetch('/api/send', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ pass, test:true })
    });
    const j = await res.json().catch(()=>{});
    return res.ok && j?.ok === 'ping';
  }

  async function unlock(){
    const pass = document.getElementById('pw').value.trim();
    if(!pass) return;
    if(await testPass(pass)){
      localStorage.setItem(KEY, pass);
      document.getElementById('login').style.display='none';
      document.getElementById('form').style.display='block';
      document.getElementById('err').style.display='none';
    } else {
      document.getElementById('err').style.display='block';
    }
  }

  /* auto-unlock if we saved a valid pass earlier */
  (async ()=>{
    const saved = localStorage.getItem(KEY);
    if(saved && await testPass(saved)){
      document.getElementById('login').style.display='none';
      document.getElementById('form').style.display='block';
    }
  })();

  async function send(){
    const pass = localStorage.getItem(KEY);
    const payload = {
      pass,
      title: document.getElementById('title').value,
      body : document.getElementById('body').value,
      url  : document.getElementById('url').value.trim() || undefined
    };
    const res = await fetch('/api/send', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const out = await res.json();
    if(res.ok) alert(`‚úÖ Sent to ${out.ok}/${out.to}`);
    else       alert('‚ùå ' + (out.error || 'Unknown error'));
  }
        </script>
