<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lecture Player</title>
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<style>
body { margin:0; background:#000; font-family: Arial, sans-serif; }
.video-container { width:100%; height:auto; position:relative; }
.plyr { width:100%; height:auto; }
.skip-overlay {
    position:absolute;
    color:#fff;
    font-size:36px;
    font-weight:bold;
    text-shadow: 0 0 8px #000;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    opacity:0;
    transition: opacity 0.3s;
    pointer-events:none;
    z-index:9999;
}
.download-btn {
    background:#28a745;
    color:#fff;
    padding:10px 20px;
    border:none;
    border-radius:5px;
    font-size:16px;
    cursor:pointer;
    box-shadow:0 2px 5px rgba(0,0,0,0.1);
}
.download-container {
    text-align:center;
    margin-top:15px;
    color:#fff;
}
.brand-text {
    margin-top:8px;
    font-size:14px;
    color:#ccc;
}
#live-badge {
    position:absolute;
    top:15px;
    right:15px;
    background:rgba(0,0,0,0.35);
    color:#fff;
    padding:4px 8px;
    border-radius:4px;
    font-size:12px;
    z-index:9999;
    display:none;
}
/* --- Popup styles --- */
#telegram-popup {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.6);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:10000;
}
#telegram-popup .popup-content {
    background:#fff;
    padding:20px;
    border-radius:8px;
    width:90%;
    max-width:350px;
    text-align:center;
    color:#000;
}
#telegram-popup button {
    margin-top:15px;
    padding:10px 15px;
    border:none;
    border-radius:5px;
    cursor:pointer;
    font-size:14px;
}
.join-btn {
    background:#0088cc;
    color:#fff;
}
.close-btn {
    background:#ccc;
}
</style>
</head>
<body>

<div class="video-container">
  <video id="lecture-player" playsinline controls autoplay></video>
  <div id="skip-overlay" class="skip-overlay"></div>
  <div id="live-badge">LIVE</div>
</div>

<div class="download-container">
  <button class="download-btn" onclick="handleDownloadClick()">Download Lecture</button>
  <div class="brand-text">EduVibe-NT</div>
</div>

<!-- Telegram Popup -->
<div id="telegram-popup">
  <div class="popup-content">
    <h3>Join Our Telegram Channel ðŸ“¢</h3>
    <p>Stay updated with the latest lectures and notes.</p>
    <a href="https://t.me/eduvibe_all_classes" target="_blank">
      <button class="join-btn">Join Now</button>
    </a>
    <br/>
    <button class="close-btn" onclick="closePopup()">Close</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>

<script>
// --- Base32 decode ---
function base32Decode(input) {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    let bits = '';
    for (let char of input.toUpperCase()) {
        let val = alphabet.indexOf(char);
        if (val === -1) continue;
        bits += val.toString(2).padStart(5,'0');
    }
    let output = '';
    for (let i = 0; i + 8 <= bits.length; i+=8) {
        output += String.fromCharCode(parseInt(bits.substr(i,8),2));
    }
    return output;
}

// --- Parse URL params ---
const urlParams = new URL(window.location.href).searchParams;
const encodedUrl = urlParams.get("url");
const isLive = urlParams.get("isLive") === "1";
const videoId = urlParams.get("videoId") || null;

if(!encodedUrl){ alert("âŒ No URL provided!"); throw new Error("No URL"); }
const m3u8Url = base32Decode(encodedUrl);

// --- Initialize Plyr ---
const videoEl = document.getElementById("lecture-player");
const videoContainer = videoEl.parentElement;

let player;
if (Hls.isSupported()) {
    const hls = new Hls();
    hls.loadSource(m3u8Url);
    hls.attachMedia(videoEl);

    // Initialize Plyr
    player = new Plyr(videoEl, {
        controls: [
            'play-large','rewind','play','fast-forward',
            'progress','current-time','duration','mute','volume',
            'settings','fullscreen'
        ],
        autoplay: true,
        speed: { selected: 1, options: [0.5, 1, 1.25, 1.5, 2] },
        settings: ['quality', 'speed']
    });

    // Add quality levels
    hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
        const availableQualities = hls.levels.map(l => l.height).sort((a, b) => b - a);

        player.options.quality = {
            default: availableQualities[0],
            options: ['Auto', ...availableQualities],
            forced: true,
            onChange: (newQuality) => {
                if(newQuality === 'Auto'){
                    hls.currentLevel = -1;
                } else {
                    hls.levels.forEach((level, levelIndex) => {
                        if (level.height === newQuality) {
                            hls.currentLevel = levelIndex;
                        }
                    });
                }
            }
        };
        player.updateSettings();
    });
}
// --- Show live badge ---
if(isLive){ document.getElementById("live-badge").style.display="block"; }

// --- Orientation Lock ---
const lockLandscape = async()=>{const o=screen.orientation;if(o?.lock){try{o.lock("landscape")}catch(_){}}};
const unlockOrientation = async()=>{const o=screen.orientation;if(o?.unlock)o.unlock();};
player.on("enterfullscreen",()=>lockLandscape());
player.on("exitfullscreen",()=>unlockOrientation());

// Prevent Plyr's built-in double-tap fullscreen
videoContainer.addEventListener("dblclick", (e) => {
  e.stopPropagation();
  e.preventDefault();
}, true);

// --- Gesture Layer ---
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
let holdTimeout=null, speedHeld=false, lastTap=0;
const skipOverlay = document.getElementById("skip-overlay");

const showSkipOverlay = (text)=>{
    skipOverlay.textContent=text;
    skipOverlay.style.opacity="1";
    setTimeout(()=>{ skipOverlay.style.opacity="0"; }, 600);
};
const handleTouchStart = () => {
    if(!isMobile) return;
    holdTimeout = setTimeout(()=>{ 
        if(player && !speedHeld){
            speedHeld=true; 
            player.speed = 2;
        } 
    }, 1000);
};
const handleTouchEnd = () => {
    if(!isMobile) return;
    clearTimeout(holdTimeout);
    if(player && speedHeld){
        player.speed = 1;
        speedHeld=false;
    }
};
const handleDoubleTap = (e) => {
    if(!isMobile) return;
    const now = Date.now();
    const tapGap = now - lastTap;
    lastTap = now;
    const {clientX} = e.changedTouches[0];
    const {left,width} = videoContainer.getBoundingClientRect();
    const tapX = clientX-left;
    if(tapGap < 300){ // double-tap
        if(tapX < width/3){
            player.currentTime -= 10;
        } else if(tapX > (2*width)/3){
            player.currentTime += 10;
        } else {
            player.togglePlay();
        }
    }
};
videoEl.addEventListener("touchstart", handleTouchStart);
videoEl.addEventListener("touchend", handleTouchEnd);
videoContainer.addEventListener("touchend", handleDoubleTap);

// --- Dummy download handler ---
function handleDownloadClick(){
    alert("ðŸ“¥ Download clicked for videoId: "+videoId);
}

// --- Telegram Popup ---
function showPopup(){
    document.getElementById("telegram-popup").style.display="flex";
}
function closePopup(){
    document.getElementById("telegram-popup").style.display="none";
}
// Show popup after short delay (only once per session)
if(!sessionStorage.getItem("telegramPopupShown")){
    setTimeout(()=>{
        showPopup();
        sessionStorage.setItem("telegramPopupShown","1");
    }, 2000);
}
</script>
</body>
  </html>
